set -e
set -v

# partition the local ssd:
# Got the file  sfdisk-sdb-ssd.layout by doing it once manually, then doing
#
#      sfdisk -d /dev/sdb >  sfdisk-sdb-ssd.layout
#
sfdisk /dev/sdb < sfdisk-sdb-ssd.layout

# layout
export TMP=/dev/sdb1
export DEV=/dev/sdb2
export MOUNT=/projects

# make fast /tmp
mkfs.ext4 /dev/sdb1
mount /dev/sdb1 /tmp
chmod 1777 /tmp

# make all the partitions and mounts
mkfs.btrfs -f $DEV
mkdir -p $MOUNT 
mount -o compress-force=lzo,noatime $DEV $MOUNT
btrfs quota enable $MOUNT 
chmod og-rw $MOUNT 
chmod og+x $MOUNT 
btrfs subvolume create $MOUNT/conf 
chown salvus. $MOUNT/conf 
btrfs subvolume create $MOUNT/sagemathcloud 
btrfs subvolume create $MOUNT/.snapshots
sudo rsync -LrxH --delete /home/salvus/salvus/salvus/local_hub_template/ $MOUNT/sagemathcloud/ 


# inspect filesystems
df -h

